<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>0FluffCook V2</title>
    <style>
        :root {
            --bg: #000000;
            --card: #1e1e24;
            --text: #ececec;
            --accent: #ff6b6b;
            --dim: #888;
            --success: #4caf50;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 { margin-bottom: 5px; letter-spacing: -1px; }
        .subtitle { color: var(--dim); font-size: 0.9rem; margin-bottom: 20px; }
        
        /* Layout */
        .container { width: 100%; max-width: 600px; padding-bottom: 80px; }
        
        /* Inputs & Buttons */
        input, textarea, button {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            background: var(--card);
            color: white;
            font-size: 1rem;
            margin-bottom: 10px;
            box-sizing: border-box;
            outline: none;
        }
        textarea { resize: vertical; }
        button {
            background: var(--accent);
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:active { transform: scale(0.98); }
        button.secondary { background: #333; }
        button.outline { background: transparent; border: 1px solid #333; color: var(--dim); }
        button.icon-btn { width: auto; padding: 8px 12px; margin: 0; }

        /* Action Row */
        .action-row { display: flex; gap: 10px; margin-bottom: 10px; }
        
        /* Recipe Cards */
        .recipe-list { display: grid; gap: 15px; width: 100%; margin-top: 20px; }
        .recipe-card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            border: 1px solid transparent;
        }
        .recipe-card.favorite { border-color: var(--accent); }
        .recipe-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; padding-right: 30px; }
        .tags { font-size: 0.8rem; color: var(--dim); display: flex; align-items: center; gap: 10px; }
        .fav-icon { position: absolute; top: 20px; right: 20px; color: var(--dim); }
        .favorite .fav-icon { color: var(--accent); }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            z-index: 100;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg);
            width: 100%; max-width: 600px;
            padding: 25px;
            border-radius: 20px;
            height: fit-content;
            border: 1px solid #333;
        }
        .ingredient-item { border-bottom: 1px solid #333; padding: 10px 0; }
        .step-item { margin-bottom: 15px; line-height: 1.5; }
        
        /* Settings */
        #settings-panel { display: none; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 20px; }
        .hidden { display: none; }
        
        /* Modal Actions */
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h1>0FluffCook</h1>
            <div class="subtitle">V2.0 | No Ads. Just Food.</div>
        </div>
        <button onclick="toggleSettings()" class="icon-btn" style="font-size:1.5rem; background:none;">‚öôÔ∏è</button>
    </div>

    <div id="settings-panel">
        <p style="font-size:0.8rem; color:var(--dim);">API Key (Gemini):</p>
        <input type="password" id="apiKeyInput" placeholder="sk-..." onchange="saveKey()">
        <div class="action-row">
            <button class="secondary" onclick="exportData()">üíæ Backup (Export JSON)</button>
            <button class="secondary" onclick="document.getElementById('importFile').click()">üìÇ Restore (Import JSON)</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>
    </div>

    <textarea id="rawInput" rows="2" placeholder="Paste URL, messy text, or ingredients..."></textarea>
    
    <div class="action-row">
        <button onclick="cook()">üî• Extract with AI</button>
        <button class="secondary" onclick="openEditor()" style="width: 40%;">+ Manual</button>
    </div>
    
    <div id="loading" class="hidden" style="text-align:center; color:var(--dim); margin:10px;">Chef is cooking...</div>

    <div class="recipe-list" id="recipeList"></div>
</div>

<div class="modal" id="recipeModal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items: flex-start;">
            <h2 id="modalTitle" style="margin-top:0;">Title</h2>
            <button onclick="closeModal('recipeModal')" class="icon-btn" style="background:none; font-size:1.5rem;">‚úï</button>
        </div>

        <div class="action-row" style="margin-bottom: 20px;">
            <button class="secondary icon-btn" onclick="toggleFavoriteCurrent()">‚ù§Ô∏è</button>
            <button class="secondary icon-btn" onclick="copyToClipboard()">üìã Copy</button>
            <button class="secondary icon-btn" onclick="editCurrentRecipe()">‚úèÔ∏è Edit</button>
        </div>

        <div style="margin: 20px 0;">
            <h3 style="color:var(--accent)">Ingredients</h3>
            <div id="modalIngredients"></div>
        </div>
        <div style="margin: 20px 0;">
            <h3 style="color:var(--accent)">Instructions</h3>
            <div id="modalSteps"></div>
        </div>

        <div class="modal-actions">
            <button class="secondary" style="background: #3a1c1c; color: #ff6b6b;" onclick="deleteCurrentRecipe()">Delete Recipe</button>
        </div>
    </div>
</div>

<div class="modal" id="editorModal">
    <div class="modal-content">
        <h2>Recipe Editor</h2>
        <input type="text" id="editTitle" placeholder="Recipe Title">
        
        <p style="font-size:0.8rem; color:var(--dim); margin-bottom:5px;">Ingredients (One per line)</p>
        <textarea id="editIngredients" rows="6"></textarea>
        
        <p style="font-size:0.8rem; color:var(--dim); margin-bottom:5px;">Steps (One per line)</p>
        <textarea id="editSteps" rows="6"></textarea>
        
        <div class="action-row">
            <button onclick="saveEditor()">üíæ Save Recipe</button>
            <button class="secondary" onclick="closeModal('editorModal')">Cancel</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let recipes = JSON.parse(localStorage.getItem('gourmet_recipes') || '[]');
    let apiKey = localStorage.getItem('gourmet_key') || '';
    let currentRecipeId = null;
    let isEditingId = null; // Tracks if we are editing an existing recipe or creating new

    // --- INIT ---
    if(apiKey) document.getElementById('apiKeyInput').value = apiKey;
    render();

    // --- CORE FUNCTIONS ---
    function toggleSettings() {
        const panel = document.getElementById('settings-panel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function saveKey() {
        apiKey = document.getElementById('apiKeyInput').value;
        localStorage.setItem('gourmet_key', apiKey);
        toggleSettings();
    }

    async function cook() {
        const input = document.getElementById('rawInput').value;
        if (!input) return alert("Feed me content first.");
        if (!apiKey) return alert("I need an API key in settings.");

        document.getElementById('loading').classList.remove('hidden');

        const prompt = `Extract the recipe from the following text. Return ONLY valid JSON with this structure: { "title": "String", "ingredients": ["String"], "steps": ["String"] }. Text to process: ${input}`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            const rawText = data.candidates[0].content.parts[0].text;
            const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '');
            const recipeData = JSON.parse(jsonStr);
            
            recipeData.id = Date.now();
            recipeData.isFavorite = false;
            
            recipes.unshift(recipeData);
            saveRecipes();
            render();
            document.getElementById('rawInput').value = '';
        } catch (e) {
            alert("Burnt the food. Check console or API key.");
            console.error(e);
        } finally {
            document.getElementById('loading').classList.add('hidden');
        }
    }

    // --- RENDER ---
    function render() {
        const list = document.getElementById('recipeList');
        list.innerHTML = '';
        
        // Sort: Favorites first, then newest
        const sortedRecipes = [...recipes].sort((a, b) => {
            if (a.isFavorite === b.isFavorite) return b.id - a.id;
            return a.isFavorite ? -1 : 1;
        });

        sortedRecipes.forEach(r => {
            const card = document.createElement('div');
            card.className = `recipe-card ${r.isFavorite ? 'favorite' : ''}`;
            card.innerHTML = `
                <div class="fav-icon">${r.isFavorite ? '‚ù§Ô∏è' : '‚ô°'}</div>
                <div class="recipe-title">${r.title}</div>
                <div class="tags">
                    <span>${r.ingredients.length} ingredients</span>
                </div>
            `;
            card.onclick = (e) => {
                // Don't open modal if clicking the heart directly (optional, but nice)
                openModal(r);
            };
            list.appendChild(card);
        });
    }

    // --- MODAL & ACTIONS ---
    function openModal(r) {
        currentRecipeId = r.id;
        document.getElementById('modalTitle').innerText = r.title;
        document.getElementById('modalIngredients').innerHTML = r.ingredients.map(i => `<div class="ingredient-item">‚Ä¢ ${i}</div>`).join('');
        document.getElementById('modalSteps').innerHTML = r.steps.map((s, i) => `<div class="step-item"><b>${i+1}.</b> ${s}</div>`).join('');
        document.getElementById('recipeModal').classList.add('active');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    function toggleFavoriteCurrent() {
        const r = recipes.find(item => item.id === currentRecipeId);
        if(r) {
            r.isFavorite = !r.isFavorite;
            saveRecipes();
            render();
            // Re-render button state visually in modal? Or just close?
            // For now, simple feedback
            closeModal('recipeModal');
        }
    }

    function deleteCurrentRecipe() {
        if(confirm("Trash this permanently?")) {
            recipes = recipes.filter(r => r.id !== currentRecipeId);
            saveRecipes();
            render();
            closeModal('recipeModal');
        }
    }

    function copyToClipboard() {
        const r = recipes.find(item => item.id === currentRecipeId);
        if(!r) return;
        
        const text = `${r.title}\n\nINGREDIENTS:\n${r.ingredients.join('\n')}\n\nSTEPS:\n${r.steps.join('\n')}`;
        navigator.clipboard.writeText(text).then(() => {
            alert("Recipe copied to clipboard!");
        });
    }

    // --- MANUAL EDITOR ---
    function openEditor() {
        // If currentRecipeId is set and we are calling from the modal, we are editing
        // If calling from main screen, we are creating
        
        // Determine context: are we editing inside the view modal?
        const viewModalOpen = document.getElementById('recipeModal').classList.contains('active');
        
        if (viewModalOpen && currentRecipeId) {
            // EDIT MODE
            const r = recipes.find(item => item.id === currentRecipeId);
            isEditingId = currentRecipeId;
            document.getElementById('editTitle').value = r.title;
            document.getElementById('editIngredients').value = r.ingredients.join('\n');
            document.getElementById('editSteps').value = r.steps.join('\n');
            closeModal('recipeModal'); // Close view modal
        } else {
            // CREATE MODE
            isEditingId = null;
            document.getElementById('editTitle').value = '';
            document.getElementById('editIngredients').value = '';
            document.getElementById('editSteps').value = '';
        }
        
        document.getElementById('editorModal').classList.add('active');
    }
    
    // Alias function for the Edit Button inside the modal
    function editCurrentRecipe() {
        openEditor();
    }

    function saveEditor() {
        const title = document.getElementById('editTitle').value;
        const ingRaw = document.getElementById('editIngredients').value;
        const stepsRaw = document.getElementById('editSteps').value;
        
        if(!title) return alert("Title is required");

        const newIngredients = ingRaw.split('\n').filter(line => line.trim() !== '');
        const newSteps = stepsRaw.split('\n').filter(line => line.trim() !== '');

        if(isEditingId) {
            // Update existing
            const index = recipes.findIndex(r => r.id === isEditingId);
            if(index !== -1) {
                recipes[index].title = title;
                recipes[index].ingredients = newIngredients;
                recipes[index].steps = newSteps;
            }
        } else {
            // Create new
            const newRecipe = {
                id: Date.now(),
                title: title,
                ingredients: newIngredients,
                steps: newSteps,
                isFavorite: false
            };
            recipes.unshift(newRecipe);
        }

        saveRecipes();
        render();
        closeModal('editorModal');
    }

    // --- IMPORT / EXPORT ---
    function exportData() {
        const dataStr = JSON.stringify(recipes, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `0FluffCook_Backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function importData(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if(Array.isArray(imported)) {
                    if(confirm(`Found ${imported.length} recipes. Overwrite current list? (Cancel to Merge)`)) {
                        recipes = imported;
                    } else {
                        // Merge logic: Add only IDs that don't exist
                        const currentIds = new Set(recipes.map(r => r.id));
                        imported.forEach(r => {
                            if(!currentIds.has(r.id)) recipes.push(r);
                        });
                    }
                    saveRecipes();
                    render();
                    alert("Import successful!");
                } else {
                    alert("Invalid file format.");
                }
            } catch(err) {
                alert("Error reading file.");
            }
        };
        reader.readAsText(file);
    }

    function saveRecipes() {
        localStorage.setItem('gourmet_recipes', JSON.stringify(recipes));
    }
</script>

</body>
</html>
